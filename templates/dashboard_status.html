{% extends "base.html" %}
{% block content %}

<main class="container-dashboard">
  <header class="dashboard-header">
    <div class="logo-title">
      <img src="/static/icons/dashboard.png" alt="Stellantis" class="logo">
      <h1>Energy Center - Dashboard de Status dos Equipamentos</h1>
    </div>
  </header>

  <!-- ====== CARDS SUPERIORES ====== -->
  <section class="cards-overview">
  <div class="card-status ok">
    <div class="icon">
      <img src="/static/icons/ok.png" alt="OK" class="icon-img">
    </div>
    <div class="info">
      <h3>Equipamentos OK</h3>
      <p class="value">{{ total_ok }}</p>
    </div>
  </div>

  <div class="card-status nok">
    <div class="icon">
      <img src="/static/icons/nok.png" alt="NOK" class="icon-img">
    </div>
    <div class="info">
      <h3>Equipamentos NOK</h3>
      <p class="value">{{ total_nok }}</p>
    </div>
  </div>

  <div class="card-status man">
    <div class="icon">
      <img src="/static/icons/manutencao.png" alt="Manutenção" class="icon-img">
    </div>
    <div class="info">
      <h3>Em Manutenção</h3>
      <p class="value">{{ total_man }}</p>
    </div>
  </div>
</section>


  <!-- ====== STATUS GERAL ====== -->
  <section class="status-geral">
    <h2>Status Geral dos Equipamentos</h2>
    <div class="chart-container small">
      <canvas id="chartStatusGeral"></canvas>
    </div>
  </section>

  <hr class="divider">

  <!-- ====== RESUMO POR TIPO ====== -->
  <section class="resumo-equipamentos">
    <h2>Resumo por Tipo de Equipamento</h2>

    <div class="table-container">
      <table class="checklist-table resumo-tipo">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Disponibilidade (%)</th>
            <th>OK</th>
            <th>NOK</th>
            <th>Manutenção</th>
          </tr>
        </thead>
        <tbody>
          {% for i in range(labels|length) %}
          {% set tipo = labels[i] %}
          {% set total = valores_ok[i] + valores_nok[i] + valores_man[i] %}
          {% set disponibilidade = ((valores_ok[i] / total) * 100) if total > 0 else 0 %}
          <tr class="linha-tipo" onclick="window.location.href='/detalhes/{{ tipo }}'">
            <td class="nome-tipo">{{ tipo }}</td>
            <td>
              <div class="barra-container">
                <div class="barra" style="width: {{ disponibilidade|round(1) }}%"></div>
              </div>
              <span class="percentual">{{ disponibilidade|round(1) }}%</span>
            </td>
            <td>{{ valores_ok[i] }}</td>
            <td>{{ valores_nok[i] }}</td>
            <td>{{ valores_man[i] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</main>

<!-- ====== IMPORTA O CHART.JS ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ====== GRÁFICO 1 - STATUS GERAL ======
  const ctxGeral = document.getElementById("chartStatusGeral").getContext("2d");

  // Plugin para exibir o texto no centro
  const centerText = {
    id: 'centerText',
    afterDraw(chart) {
      const { ctx, chartArea: { width, height } } = chart;
      ctx.save();
      const x = chart.getDatasetMeta(0).data[0].x;
      const y = chart.getDatasetMeta(0).data[0].y;
      ctx.font = 'bold 20px Segoe UI';
      ctx.fillStyle = '#243881';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('{{ disponibilidade }}%', x, y - 10);
      ctx.font = 'bold 14px Segoe UI';
      ctx.fillText('Disponibilidade', x, y + 15);
      ctx.restore();
    }
  };

  new Chart(ctxGeral, {
    type: "doughnut",
    data: {
      labels: ["OK", "NOK", "Manutenção"],
      datasets: [{
        data: [{{ total_ok }}, {{ total_nok }}, {{ total_man }}],
        backgroundColor: ["#28a745", "#dc3545", "#ffc107"],
        borderWidth: 2,
      }],
    },
    options: {
      cutout: "70%",
      plugins: {
        legend: { position: "bottom", labels: { color: "#243881" } },
        title: { display: false } // o texto agora fica dentro do gráfico
      }
    },
    plugins: [centerText]
  });
</script>


{% endblock %}
