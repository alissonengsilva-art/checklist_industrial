{% extends "base.html" %}
{% block content %}

<main class="container dashboard-page">

  <h1>üìä Dashboard de Status dos Equipamentos</h1>

  <!-- ===== CARDS DE STATUS ===== -->
  <div class="status-cards">
    <div class="card ok">
      <div class="icon">‚úÖ</div>
      <div class="info">
        <h3>Equipamentos OK</h3>
        <p class="value">{{ total_ok }}</p>
        <div class="progress">
          <div class="progress-bar green"
            style="width: {{ (total_ok / (total_ok + total_nok + total_man)) * 100 if (total_ok + total_nok + total_man) > 0 else 0 }}%;">
          </div>
        </div>
      </div>
    </div>

    <div class="card nok">
      <div class="icon">‚ùå</div>
      <div class="info">
        <h3>Equipamentos NOK</h3>
        <p class="value">{{ total_nok }}</p>
        <div class="progress">
          <div class="progress-bar red"
            style="width: {{ (total_nok / (total_ok + total_nok + total_man)) * 100 if (total_ok + total_nok + total_man) > 0 else 0 }}%;">
          </div>
        </div>
      </div>
    </div>

    <div class="card man">
      <div class="icon">üõ†Ô∏è</div>
      <div class="info">
        <h3>Em Manuten√ß√£o</h3>
        <p class="value">{{ total_man }}</p>
        <div class="progress">
          <div class="progress-bar yellow"
            style="width: {{ (total_man / (total_ok + total_nok + total_man)) * 100 if (total_ok + total_nok + total_man) > 0 else 0 }}%;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== GR√ÅFICO GERAL ======== -->
  <section class="grafico-section">
    <h2>Status Geral dos Equipamentos</h2>
    <canvas id="graficoGeral" height="140"></canvas>
  </section>

  <!-- ======== RESUMO POR TIPO ======== -->
  <section class="resumo-tipo">
    <h2>üìà Resumo por Tipo de Equipamento</h2>

    <table class="tabela-resumo">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Disponibilidade (%)</th>
          <th>OK</th>
          <th>NOK</th>
          <th>Manuten√ß√£o</th>
        </tr>
      </thead>
      <tbody>
        {% for tipo, dados in resumo.items() %}
        {% set total = dados.ok + dados.nok + dados.man %}
        {% set disponibilidade = (dados.ok / total * 100) if total > 0 else 0 %}
        <tr>
          <td>
            <a href="/detalhes/{{ tipo }}" class="link-tipo">
              <strong>{{ tipo }}</strong>
            </a>
          </td>
          <td>
            <div class="barra-progresso">
              <div class="progresso" style="width: {{ disponibilidade }}%"></div>
            </div>
            {{ disponibilidade | round(1) }}%
          </td>
          <td class="ok">{{ dados.ok }}</td>
          <td class="nok">{{ dados.nok }}</td>
          <td class="man">{{ dados.man }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ===== DETALHES ===== -->
  <!-- <section class="detalhes-equipamentos">
    <h2>üìä Detalhes por Tipo de Equipamento</h2>

    <div class="filtros-tipo">
      <a href="/dashboard_status" class="filtro-btn ativo">Todos</a>
      <a href="/detalhes/Torre" class="filtro-btn">Torres</a>
      <a href="/detalhes/Compressor" class="filtro-btn">Compressor</a>
      <a href="/detalhes/Bomba √°gua gelada" class="filtro-btn">BAG</a>
      <a href="/detalhes/Bomba Resfiamento" class="filtro-btn">BAC</a>
      <a href="/detalhes/Chiller" class="filtro-btn">Chillers</a>
    </div>

    <table class="tabela-detalhes">
      <thead>
        <tr>
          <th>Equipamento</th>
          <th>Tipo</th>
          <th>Status</th>
          <th>Observa√ß√£o</th>
          <th>T√©cnico</th>
          <th>√öltima Atualiza√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabela-corpo">
        {% for e in equipamentos %}
        <tr data-tipo="{{ e.tipo }}">
          <td>{{ e.nome_equipamento }}</td>
          <td>{{ e.tipo }}</td>
          <td class="status {{ e.status|lower }}">{{ e.status }}</td>
          <td>{{ e.observacao or '-' }}</td>
          <td>{{ e.tecnico or '-' }}</td>
          <td>{{ e.data_atualizacao.strftime("%d/%m/%Y %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

</main> -->

<!-- ===== GR√ÅFICO DONUT ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const totalOK = Number("{{ total_ok or 0 }}");
  const totalNOK = Number("{{ total_nok or 0 }}");
  const totalMAN = Number("{{ total_man or 0 }}");
  const totalAll = totalOK + totalNOK + totalMAN;
  const percentDisponibilidade = totalAll > 0 ? Math.round((totalOK / totalAll) * 100) : 0;

  const ctx = document.getElementById("graficoGeral").getContext("2d");
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["OK", "NOK", "Manuten√ß√£o"],
      datasets: [{
        data: [totalOK, totalNOK, totalMAN],
        backgroundColor: ["#28a745", "#dc3545", "#ffc107"],
        borderWidth: 0,
        cutout: "70%"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom", labels: { boxWidth: 15 } },
        title: {
          display: true,
          text: "Status Geral dos Equipamentos",
          color: "#243881",
          font: { size: 18, weight: "bold" }
        }
      },
      animation: { animateScale: true, animateRotate: true, duration: 1000 }
    },
    plugins: [{
      id: "centerText",
      afterDraw(chart) {
        const { ctx, chartArea } = chart;
        const x = (chartArea.left + chartArea.right) / 2;
        const y = (chartArea.top + chartArea.bottom) / 2;
        ctx.save();
        ctx.font = "bold 28px Segoe UI";
        ctx.fillStyle = "#243881";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(percentDisponibilidade + "%", x, y);
        ctx.font = "14px Segoe UI";
        ctx.fillStyle = "#555";
        ctx.fillText("Disponibilidade", x, y + 25);
        ctx.restore();
      }
    }]
  });
</script>

{% endblock %}
